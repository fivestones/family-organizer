services:
  # --- 1. Family Organizer App ---
  family-organizer:
    container_name: family-organizer
    image: family-organizer:latest
    restart: unless-stopped
    build:
      context: .
      dockerfile: Dockerfile
      # These bake the PUBLIC URLs into the JavaScript bundle at build time.
      # Changing these requires running `docker compose up -d --build`.
      args:
        NEXT_PUBLIC_S3_ENDPOINT: ${NEXT_PUBLIC_S3_ENDPOINT}
        NEXT_PUBLIC_INSTANT_API_URI: ${NEXT_PUBLIC_INSTANT_API_URI}
        NEXT_PUBLIC_INSTANT_WEBSOCKET_URI: ${NEXT_PUBLIC_INSTANT_WEBSOCKET_URI}
        NEXT_PUBLIC_INSTANT_APP_ID: ${NEXT_PUBLIC_INSTANT_APP_ID}
    ports:
      - '${APP_PORT}:3000'
    env_file:
      - .env
    environment:
      # --- Server-Side Config (Internal Docker Network) ---
      # The server uses the internal container name "minio".
      # This keeps traffic inside the docker network and avoids SSL overhead internally.
      - S3_ENDPOINT=http://minio:9000
      - S3_BUCKET_NAME=family-organizer
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      - DEVICE_ACCESS_KEY=${DEVICE_ACCESS_KEY}
      # Node environment settings
      - NODE_ENV=production
      - HOSTNAME=0.0.0.0
    depends_on:
      - minio
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - default

  # --- 2. MinIO (S3 Compatible Storage) ---
  minio:
    image: minio/minio
    container_name: minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    ports:
      - '${MINIO_PORT}:9000'        # API Port
      - '${MINIO_CONSOLE_PORT}:9001' # Console Port
    environment:
      - MINIO_ROOT_USER=${S3_ACCESS_KEY_ID}
      - MINIO_ROOT_PASSWORD=${S3_SECRET_ACCESS_KEY}
      # CRITICAL: Tells MinIO its public identity so Presigned URLs use the domain, not the container IP
      - MINIO_SERVER_URL=${NEXT_PUBLIC_S3_ENDPOINT}
      # Optional: If you proxy the console as well
      - MINIO_BROWSER_REDIRECT_URL=${MINIO_BROWSER_REDIRECT_URL}
    volumes:
      - minio_data:/data
    networks:
      - default
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 20s
      retries: 3

  # --- 3. Create Buckets (One-off initialization) ---
  createbuckets:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    env_file:
      - .env
    entrypoint: |
      /bin/sh -c "
      echo '--- DEBUG START ---'
      
      # 1. Verify DNS: Who is 'minio'?
      #echo 'Pinging minio...'
      #ping -c 1 minio
      
      # 2. Connect
      until /usr/bin/mc alias set myminio http://minio:9000 \${S3_ACCESS_KEY_ID} \${S3_SECRET_ACCESS_KEY}; do
        echo '...waiting for minio...';
        sleep 1;
      done;
      
      # 3. Create Bucket
      /usr/bin/mc mb -p myminio/family-organizer;
      /usr/bin/mc anonymous set download myminio/family-organizer;
      
      # 4. VERIFY: List remote buckets to prove server has it
      echo '--- SERVER BUCKET LIST ---'
      /usr/bin/mc ls myminio/
      
      # 5. TRAP CHECK: Did we accidentally create a local folder?
      #echo '--- LOCAL FILESYSTEM CHECK ---'
      #ls -R / | grep family-organizer || echo 'No local folder found (Good!)'
      
      echo 'Bucket setup complete.'
      exit 0;
      "
    networks:
      - default

volumes:
  minio_data:

# use the network that linuxserver.io swag is on so it can be easily reverse proxied
networks:
  default:
    name: docker_default
    external: True
