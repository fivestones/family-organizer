version: '3.8'

services:
    # --- 1. Family Organizer App ---
    family-app:
        build: .
        container_name: family-app
        restart: unless-stopped
        ports:
            - '${APP_PORT}:3000'
        environment:
            # Public URLs
            - NEXT_PUBLIC_S3_ENDPOINT=http://localhost:${MINIO_PORT}
            - NEXT_PUBLIC_INSTANT_API_URI=http://localhost:${INSTANT_PORT}
            - NEXT_PUBLIC_INSTANT_WEBSOCKET_URI=ws://localhost:${INSTANT_PORT}/runtime/session
            - NEXT_PUBLIC_INSTANT_APP_ID=${NEXT_PUBLIC_INSTANT_APP_ID}
            # Internal Secrets & Config
            - S3_ENDPOINT=http://minio:9000
            - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
            - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
            - S3_BUCKET_NAME=family-organizer
            - DEVICE_ACCESS_KEY=${DEVICE_ACCESS_KEY}
        depends_on:
            - minio
            - instant-server

    # --- 2. MinIO (S3 Storage) ---
    minio:
        image: minio/minio
        container_name: minio
        command: server /data --console-address ":9001"
        ports:
            - '${MINIO_PORT}:9000'
            - '${MINIO_CONSOLE_PORT}:9001'
        environment:
            - MINIO_ROOT_USER=${S3_ACCESS_KEY_ID}
            - MINIO_ROOT_PASSWORD=${S3_SECRET_ACCESS_KEY}
        volumes:
            - minio_data:/data

    createbuckets:
        image: minio/mc
        depends_on:
            - minio
        entrypoint: >
            /bin/sh -c " /usr/bin/mc config host add myminio http://minio:9000 ${S3_ACCESS_KEY_ID} ${S3_SECRET_ACCESS_KEY}; /usr/bin/mc mb myminio/family-organizer; /usr/bin/mc anonymous set download myminio/family-organizer; exit 0; "


    # --- 3. InstantDB Server ---
    instant-postgres:
        image: postgres:16-alpine
        container_name: instant-postgres
        environment:
            - POSTGRES_USER=instant
            - POSTGRES_PASSWORD=${INSTANT_DB_PASSWORD:-instant_password}
            - POSTGRES_DB=instant
        volumes:
            - instant_data:/var/lib/postgresql/data
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U instant']
            interval: 5s
            timeout: 5s
            retries: 5

    instant-server:
        image: clojure:tools-deps
        container_name: instant-server
        working_dir: /app/server
        # FIX: Use '|' to preserve newlines for the bash script
        command: |
            /bin/bash -c "
            if [ ! -d '/app/.git' ]; then
              echo 'Cloning InstantDB repo...'
              rm -rf /app/* /app/.* 2>/dev/null || true
              git clone https://github.com/instantdb/instant.git /app
            fi

            echo 'Starting InstantDB Server...'
            cd /app/server && clj -M:dev -m instant.main
            "
        ports:
            - '${INSTANT_PORT}:8888'
        environment:
            - AWS_REGION=us-east-1
            - AWS_ACCESS_KEY_ID=dummy
            - AWS_SECRET_ACCESS_KEY=dummy
            - DATABASE_URL=jdbc:postgresql://instant-postgres:5432/instant?user=instant&password=${INSTANT_DB_PASSWORD:-instant_password}
            - INSTANT_JWT_SECRET=${INSTANT_JWT_SECRET}
            - INSTANT_SESSION_SECRET=${INSTANT_SESSION_SECRET}
            - SEND_IN_DEV=true
        volumes:
            - instant-repo-cache:/app
        depends_on:
            instant-postgres:
                condition: service_healthy

    # --- 4. InstantDB Client (Dashboard) ---
    instant-client:
        image: node:18-alpine
        container_name: instant-client
        working_dir: /app/client
        # FIX: Use '|' to preserve newlines and fix syntax errors
        command: |
            /bin/sh -c "
            apk add --no-cache make

            # Wait for repo to be cloned
            while [ ! -d '/app/client' ]; do 
              echo 'Waiting for repo...'
              sleep 2
            done

            cd /app/client
            if [ ! -d 'node_modules' ]; then
              echo 'Installing Dashboard dependencies...'
              corepack enable && pnpm install
            fi

            echo 'Starting Dashboard via Make...'
            export NEXT_PUBLIC_INSTANT_URL=http://localhost:${INSTANT_PORT}
            make dev
            "
        ports:
            - '${DASHBOARD_PORT}:3000'
        volumes:
            - instant-repo-cache:/app
        depends_on:
            - instant-server

volumes:
    minio_data:
    instant_data:
    instant-repo-cache:
