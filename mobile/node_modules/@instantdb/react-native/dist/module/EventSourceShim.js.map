{"version":3,"file":"EventSourceShim.js","sourceRoot":"","sources":["../../src/EventSourceShim.ts"],"names":[],"mappings":"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","sourcesContent":["import { type EventSourceType } from '@instantdb/core';\n\n// Modified version of https://github.com/binaryminds/react-native-sse/blob/master/src/EventSource.js\n// that conforms to our `EventSourceType` subset of the browser-native `EventSource`.\n\nconst XMLReadyStateMap = [\n  'UNSENT',\n  'OPENED',\n  'HEADERS_RECEIVED',\n  'LOADING',\n  'DONE',\n];\n\nclass EventSource implements EventSourceType {\n  private ERROR = -1;\n  static CONNECTING = 0;\n  static OPEN = 1;\n  static CLOSED = 2;\n\n  private CRLF = '\\r\\n';\n  private LF = '\\n';\n  private CR = '\\r';\n\n  readonly url: string;\n\n  onopen;\n  onerror;\n  onmessage;\n\n  debug: boolean;\n\n  private status: number;\n\n  private headers = {\n    Accept: 'text/event-stream',\n    'Cache-Control': 'no-cache',\n    'X-Requested-With': 'XMLHttpRequest',\n  };\n\n  private _xhr: XMLHttpRequest | null;\n  private lineEndingCharacter: string | null;\n  private _lastIndexProcessed: number;\n\n  constructor(url) {\n    this.status = EventSource.CONNECTING;\n\n    this.lineEndingCharacter = null;\n    this._xhr = null;\n    this._lastIndexProcessed = 0;\n    this.debug = false;\n\n    if (!url || typeof url !== 'string') {\n      throw new SyntaxError('[EventSource] Invalid URL argument.');\n    }\n\n    this.url = url;\n\n    this.open();\n  }\n\n  public get readyState() {\n    if (this.status === this.ERROR) {\n      return EventSource.CLOSED;\n    }\n    return this.status;\n  }\n\n  open() {\n    try {\n      this.status = EventSource.CONNECTING;\n\n      this._lastIndexProcessed = 0;\n\n      this._xhr = new XMLHttpRequest();\n      this._xhr.open('GET', this.url, true);\n\n      for (const [key, value] of Object.entries(this.headers)) {\n        if (value !== undefined && value !== null) {\n          this._xhr.setRequestHeader(key, value);\n        }\n      }\n\n      this._xhr.onreadystatechange = () => {\n        if (this.status === EventSource.CLOSED) {\n          return;\n        }\n\n        const xhr = this._xhr!;\n\n        this._logDebug(\n          `[EventSource][onreadystatechange] ReadyState: ${XMLReadyStateMap[xhr.readyState] || 'Unknown'}(${\n            xhr.readyState\n          }), status: ${xhr.status}`,\n        );\n\n        if (\n          xhr.readyState !== XMLHttpRequest.DONE &&\n          xhr.readyState !== XMLHttpRequest.LOADING\n        ) {\n          return;\n        }\n\n        if (xhr.status >= 200 && xhr.status < 400) {\n          if (this.status === EventSource.CONNECTING) {\n            this.status = EventSource.OPEN;\n            this.dispatch('open', { type: 'open' });\n            this._logDebug(\n              '[EventSource][onreadystatechange][OPEN] Connection opened.',\n            );\n          }\n\n          this._handleEvent(xhr.responseText || '');\n\n          if (xhr.readyState === XMLHttpRequest.DONE) {\n            this._logDebug(\n              '[EventSource][onreadystatechange][DONE] Operation done.',\n            );\n            this.dispatch('error', { type: 'error' });\n          }\n        } else if (xhr.status !== 0) {\n          this.status = this.ERROR;\n          this.dispatch('error', {\n            type: 'error',\n            message: xhr.responseText,\n            xhrStatus: xhr.status,\n            xhrState: xhr.readyState,\n          });\n\n          if (xhr.readyState === XMLHttpRequest.DONE) {\n            this._logDebug(\n              '[EventSource][onreadystatechange][ERROR] Response status error.',\n            );\n          }\n        }\n      };\n\n      this._xhr.onerror = () => {\n        if (this.status === EventSource.CLOSED) {\n          return;\n        }\n\n        this.status = this.ERROR;\n        this.dispatch('error', {\n          type: 'error',\n          message: this._xhr!.responseText,\n          xhrStatus: this._xhr!.status,\n          xhrState: this._xhr!.readyState,\n        });\n      };\n\n      this._xhr.send();\n    } catch (e) {\n      this.status = this.ERROR;\n      this.dispatch('error', {\n        type: 'exception',\n        message: e.message,\n        error: e,\n      });\n    }\n  }\n\n  _logDebug(...msg) {\n    if (this.debug) {\n      console.debug(...msg);\n    }\n  }\n\n  _handleEvent(response) {\n    if (this.lineEndingCharacter === null) {\n      const detectedNewlineChar = this._detectNewlineChar(response);\n      if (detectedNewlineChar !== null) {\n        this._logDebug(\n          `[EventSource] Automatically detected lineEndingCharacter: ${JSON.stringify(\n            detectedNewlineChar,\n          ).slice(1, -1)}`,\n        );\n        this.lineEndingCharacter = detectedNewlineChar;\n      } else {\n        console.warn(\n          \"[EventSource] Unable to identify the line ending character. Ensure your server delivers a standard line ending character: \\\\r\\\\n, \\\\n, \\\\r, or specify your custom character using the 'lineEndingCharacter' option.\",\n        );\n        return;\n      }\n    }\n\n    const indexOfDoubleNewline = this._getLastDoubleNewlineIndex(response);\n    if (indexOfDoubleNewline <= this._lastIndexProcessed) {\n      return;\n    }\n\n    const parts = response\n      .substring(this._lastIndexProcessed, indexOfDoubleNewline)\n      .split(this.lineEndingCharacter);\n\n    this._lastIndexProcessed = indexOfDoubleNewline;\n\n    let type: string | undefined = undefined;\n    let data: string[] = [];\n    let line = '';\n\n    for (let i = 0; i < parts.length; i++) {\n      line = parts[i].trim();\n      if (line.startsWith('event')) {\n        type = line.replace(/event:?\\s*/, '');\n      } else if (line.startsWith('retry')) {\n        // Ignore for our use case, we'll reconnect with a new\n        // instance on error\n      } else if (line.startsWith('data')) {\n        data.push(line.replace(/data:?\\s*/, ''));\n      } else if (line.startsWith('id')) {\n        // Ignore this, not used for our use case\n      } else if (line === '') {\n        if (data.length > 0) {\n          const eventType = type || 'message';\n          const event = {\n            type: eventType,\n            data: data.join('\\n'),\n            url: this.url,\n          };\n\n          this.dispatch(eventType, event);\n\n          data = [];\n          type = undefined;\n        }\n      }\n    }\n  }\n\n  _detectNewlineChar(response) {\n    const supportedLineEndings = [this.CRLF, this.LF, this.CR];\n    for (const char of supportedLineEndings) {\n      if (response.includes(char)) {\n        return char;\n      }\n    }\n    return null;\n  }\n\n  _getLastDoubleNewlineIndex(response) {\n    const doubleLineEndingCharacter =\n      this.lineEndingCharacter! + this.lineEndingCharacter!;\n    const lastIndex = response.lastIndexOf(doubleLineEndingCharacter);\n    if (lastIndex === -1) {\n      return -1;\n    }\n\n    return lastIndex + doubleLineEndingCharacter.length;\n  }\n\n  dispatch(type, data) {\n    switch (type) {\n      case 'open': {\n        if (this.onopen) {\n          this.onopen(data);\n        }\n        break;\n      }\n      case 'error': {\n        if (this.onerror) {\n          this.onerror(data);\n        }\n        break;\n      }\n      case 'message': {\n        if (this.onmessage) {\n          this.onmessage(data);\n        }\n        break;\n      }\n    }\n  }\n\n  close() {\n    if (this.status !== EventSource.CLOSED) {\n      this.status = EventSource.CLOSED;\n    }\n\n    if (this._xhr) {\n      this._xhr.abort();\n    }\n  }\n}\n\nexport default EventSource;\n"]}